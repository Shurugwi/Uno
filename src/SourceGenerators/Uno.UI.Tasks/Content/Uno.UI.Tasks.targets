<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
	<UnoUIMSBuildTasksPath Condition="'$(UnoUIMSBuildTasksPath)'==''">..\Uno.UI.Tasks</UnoUIMSBuildTasksPath>
	<UmbrellaMSBuildTasksImported>true</UmbrellaMSBuildTasksImported>
  </PropertyGroup>

  <ItemGroup>
	<UnoSourceGeneratorBeforeTarget Condition="'$(XamarinProjectType)'=='android'" Include="UpdateAndroidAssets" />
  </ItemGroup>

  <UsingTask AssemblyFile="$(UnoUIMSBuildTasksPath)\Uno.UI.Tasks.v0.dll" TaskName="Uno.UI.Tasks.ResourcesGenerator.ResourcesGenerationTask_v0" />
  <UsingTask AssemblyFile="$(UnoUIMSBuildTasksPath)\Uno.UI.Tasks.v0.dll" TaskName="Uno.UI.Tasks.Assets.RetargetAssets_v0" />

  <Target Name="UnoResourcesGeneration"
				  BeforeTargets="PrepareForBuild;_CheckForContent"
				  DependsOnTargets="AssignLinkMetadata"
				  Condition="'$(BuildingProject)' == 'true' and '$(BuildingInsideUnoSourceGenerator)' == '' and ('$(XamarinProjectType)'!='' or '$(UnoForceProcessPRIResource)'!='')">

    <MSBuild Projects="$(MSBuildProjectFile)"
             Targets="_InnerUnoResourcesGeneration_Resources"
             BuildInParallel="true"
             Properties="Configuration=$(Configuration);Platform=$(Platform);Dummy1=true">
      <Output TaskParameter="TargetOutputs" ItemName="UnoResourceFiles" />
    </MSBuild>
    
	<ItemGroup>
	  <BundleResource Condition="'%(UnoResourceFiles.UnoResourceTarget)' =='iOS'" Include="@(UnoResourceFiles)" />
	  <AndroidResource Condition="'%(UnoResourceFiles.UnoResourceTarget)' =='Android'" Include="@(UnoResourceFiles)" />
	  <EmbeddedResource Condition="'%(UnoResourceFiles.UnoResourceTarget)' =='Uno'" Include="@(UnoResourceFiles)" />
	</ItemGroup>
    
    <MSBuild Projects="$(MSBuildProjectFile)"
             Targets="_InnerUnoResourcesGeneration_Assets"
             BuildInParallel="true"
             Properties="Configuration=$(Configuration);Platform=$(Platform);Dummy2=true">
      <Output TaskParameter="TargetOutputs" ItemName="UnoRetargetedAssetsOutput" />
    </MSBuild>
    
    <ItemGroup>
      <Content Condition="'%(UnoRetargetedAssetsOutput.OutputType)' =='Assets'" Remove="@(UnoRetargetedAssetsOutput)" />
      <BundleResource Condition="'%(UnoRetargetedAssetsOutput.OutputType)' =='ios'" Include="@(UnoRetargetedAssetsOutput)" />
      <AndroidResource Condition="'%(UnoRetargetedAssetsOutput.OutputType)' =='android'" Include="@(UnoRetargetedAssetsOutput)" />
    </ItemGroup>

  </Target>

  <Target Name="_InnerUnoResourcesGeneration_Resources"
		  DependsOnTargets="AssignLinkMetadata"
          Outputs="@(UnoGeneratedFiles)">

    <CheckForDevenv />

    <!-- String resources -->
    <PropertyGroup>
      <!-- LEGACY: Old projects define DefaultApplicationLanguage instead of DefaultLanguage -->
      <DefaultLanguage Condition="'$(DefaultLanguage)'=='' and '$(DefaultApplicationLanguage)'!=''">$(DefaultApplicationLanguage)</DefaultLanguage>
      <!-- Default to English if DefaultLanguage isn't set -->
      <DefaultLanguage Condition="'$(DefaultLanguage)'==''">en</DefaultLanguage>
      <XamarinProjectType Condition="'$(UnoForceProcessPRIResource)'!=''"></XamarinProjectType>
    </PropertyGroup>
    <ResourcesGenerationTask_v0 Resources="@(PRIResource)"
							   TargetProjectDirectory="$(ProjectDir)"
							   TargetPlatform="$(XamarinProjectType)"
							   IntermediateOutputPath="$(IntermediateOutputPath)"
							   DefaultLanguage="$(DefaultLanguage)">
      <Output TaskParameter="GeneratedFiles"
					  ItemName="UnoGeneratedFiles" />
    </ResourcesGenerationTask_v0>
  </Target>
  
  <Target Name="_InnerUnoResourcesGeneration_Assets"
		  DependsOnTargets="AssignLinkMetadata"
          Outputs="@(UnoRetargetedAssets)">
    
    <CheckForDevenv />

  <!-- Assets -->
	<PropertyGroup>
	  <UseHighDPIResources Condition="'$(UseHighDPIResources)'==''">True</UseHighDPIResources>
	</PropertyGroup>
	<RetargetAssets_v0 UseHighDPIResources="$(UseHighDPIResources)"
						TargetPlatform="$(XamarinProjectType)"
						DefaultLanguage="$(DefaultLanguage)"
						ContentItems="@(Content)"
						Condition="'$(XamarinProjectType)'!=''">
	  <Output TaskParameter="Assets"
					  ItemName="UnoAssets" />
	  <Output TaskParameter="RetargetedAssets"
					  ItemName="UnoRetargetedAssets" />
	</RetargetAssets_v0>

    <ItemGroup>
      <UnoRetargetedAssets Include="@(UnoAssets)">
        <OutputType>Assets</OutputType>
      </UnoRetargetedAssets>
      <UnoRetargetedAssets Include="@(RetargetedAssets)">
        <OutputType>$(XamarinProjectType)</OutputType>
      </UnoRetargetedAssets>
    </ItemGroup>
   
  </Target>

    <UsingTask
      TaskName="CheckForDevenv"
      TaskFactory="CodeTaskFactory"
      AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
      <ParameterGroup />
      <Task>
        <Reference Include="System.Xml"/>
        <Using Namespace="System"/>
        <Using Namespace="System.IO"/>
        <Code Type="Fragment" Language="cs">
          <![CDATA[  
            if (System.Diagnostics.Process.GetCurrentProcess().ProcessName.Equals("devenv", System.StringComparison.OrdinalIgnoreCase)) { throw new System.Exception(); }
]]>
        </Code>
      </Task>
    </UsingTask>

</Project>
